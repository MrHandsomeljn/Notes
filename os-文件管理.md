## 文件管理

- 文件的属性
- 文件内部数据组织
- 文件之间数据组织
- 系统调用
- 磁盘管理

### 文件的属性

- 文件名 ：寻找文件的根据
- 标识符 ：操作系统内部对文件的唯一标识
- 文件类型 ：打开文件的方式
- 文件的存放路径（用户）、在外存的地址（系统）
- 元数据
- 权限

### 文件内部数据组织

无结构文件，流式文件（如txt）
有结构文件，记录式文件（如表格）
- 一般来说，每条记录有一个关键字(key)
- 定长记录/可变长记录
- **顺序文件**（不方便增删）
	- 物理上可以是：
		- 顺序存储（逻辑相邻，物理相邻）（**考试一般指的这个**）
		- 链式存储（逻辑相邻，物理不一定相邻）
	- 记录与关键字的关系可以是：
		- 串结构（无关）
		- 顺序结构（顺序排列）
	- 可否随机存取：
		- 链式存储 不可以
		- 顺序存储
			- 可变长记录 不可以
			- 定长记录 可以
				- 串结构 仅关键字可以
				- 顺序结构 都可以
- **索引文件**（方便增删，可变长记录快速查找）
	- 建立索引表
		- 可根据多个数据项建立多个索引表

- **索引顺序文件**（解决索引文件空间占用问题）
	- 将记录分为连续存储的多组
	- 一组记录对应一个索引表项
	- 更大的规模可以建立更多级的索引

**考点**：记录查找需要的查找次数

操作系统会维护一个日志文件，记录对文件的修改内容，每隔一段时间将修改与硬盘同步

### 文件之间数据组织

文件目录：
- 文件控制块（FCB，实现文件目录的数据结构）
	- <文件名,文件物理地址>
- 目录（FCB的有序集合，存储为文件）
	- 功能：
		- 搜索
		- 创建项
		- 删除项
		- 显示目录
		- 修改目录（重命名等）
- 目录结构
	- 单极目录结构
		- 整个系统只有一张目录，不能创建同名文件
	- 两级目录结构
		- 主文件目录<用户,用户文件目录>
		- 用户文件目录<用户文件名,文件地址>
	- 多级目录结构（树形）
		- 根据绝对路径一层层读入目录表
		- 优化：记录当前目录（相对路径）
	- 无环目录结构（便于文件共享）
		- 可以用不同目录项指向同一个文件/目录
		- 需要对每个共享节点设置一个共享计数器，引用一次+1，删除一次-1
- 索引节点（对文件控制块的优化）
	- 表中只存储<文件名,索引节点号>，其他内容放到文件索引节点中
	- 在磁盘中时称为“磁盘索引节点，”读入内存后称为“内存索引节点”
	- 内存索引节点还需要增加文件是否被修改、有几个进程正在访问该文件等信息。

### 系统调用
1. 创建create
2. 删除delete
3. 打开open
4. 关闭close
5. 读文件read
6. 写文件write
7. 文件共享
8. 文件权限保护

### 磁盘管理
- 存储单元 (1B)
- 磁盘块/物理块 (1K)
	- 文件逻辑地址：物理块号+块内地址
	- 以块为单位进行分配、读取
- 分配方式
	- 连续分配：起始块号，长度（使用块的个数）
		- 支持随机访问
		- 顺序访问更快
		- 碎片多，文件大小扩展效率低
	- 链接分配
		- 隐式链接（**题目默认为隐式链接**）
			- 各个块使用一定空间存储下一个块的指针
			- IO次数多，要读每个块，查找效率低
		- 显式链接
			- 存储在FAT文件分配表（静态链表前向表）
			- 目录<文件名,起始块号>，起始块中存储文件分配表
			- IO次数少，只需要读取分配表
	- 索引分配
		- 为每个文件建立一张索引表（占用一个块-索引块）
		- 目录记录<文件名,索引块地址>
		- 索引表记录文件的<逻辑块,物理块>
		- 支持随机访问，方便文件拓展，占用空间大
		- 问题：文件过大，一个块中放不下索引表
			1. 多个索引块链接存储
			2. 多层索引（访问更快）
			3. 混合索引（解决多层索引小文件访问次数过多问题）
				- 顶级索引
					- 直接地址
					- 直接地址
					- 一级间接索引
						- 二级间接索引
						- 直接地址
					- ……
		- **考点**
			1. 根据索引结构计算文件最大长度
			2. 分析访问数据块的IO次数，注意顶级索引是否在内存中
- 存储空间管理
	- 存储空间划分
		- 文件卷（逻辑卷）
			- 目录区
			- 文件区
	- 管理方式
		- 空闲表法
			- 空闲表<空闲盘块首地址, 空闲盘块长度>
			- 分配：
				1. 首次适应
				2. 最佳适应
				3. 最坏适应
				4. ……
			- 回收
		- 空闲链表法
			- 空闲盘块链
				- 每个空闲盘块存储一个next
				- 分配：直接分配
			- 空闲盘区链
				- 连续的空闲盘块组成一个空闲盘区
				- 每个空闲盘区存储一个盘区长度、next
				- 分配：类似空闲表法
		- 位视图法
			- 0,1存储是否被占用
			- 字号i，位号j，字长w，盘号=w*i+j
		- 成组链接法（适用于大型文件系统）
			- 文件卷分为：
				- 目录区
					- 目录
					- 超级块
						- 与内存同步
						- list<空闲块号>, listsize
						- list[0]存储了下一层的表
						- 本身也可以被分配
				- 文件区