## 文件管理

- 文件的属性
- 文件内部数据组织
- 文件之间数据组织
- 系统调用
- 磁盘管理

## 文件的属性

- 文件名：寻找文件的根据
- 标识符：操作系统内部对文件的唯一标识
- 文件类型：打开文件的方式
- 文件的存放路径（用户）、在外存的地址（系统）
- 元数据
- 权限

## 文件内部数据组织

无结构文件，流式文件（如txt）

有结构文件，记录式文件（如表格）：
- 一般来说，每条记录有一个关键字(key)
- 定长记录/可变长记录
- **顺序文件**（不方便增删）
	- 物理上可以是：
		- 顺序存储（逻辑相邻，物理相邻）（**考试一般指的这个**）
		- 链式存储（逻辑相邻，物理不一定相邻）
	- 记录与关键字的关系可以是：
		|结构|空间关系|
		|-|-|
		|串结构|链式，关键字->记录
		|顺序结构|连续，<关键字,记录>
	- 可否随机存取：
		- 链式存储 不可以
		- 顺序存储
			- 可变长记录 不可以
			- 定长记录 可以
				- 串结构 仅关键字可以
				- 顺序结构 都可以
- **索引文件**（方便增删，可变长记录快速查找）
	- 建立索引表
		- 可根据多个数据项建立多个索引表

- **索引顺序文件**（解决索引文件空间占用问题）
	- 将记录分为连续存储的多组
	- 一组记录对应一个索引表项
	- 更大的规模可以建立更多级的索引

**考点**：记录查找需要的查找次数

操作系统会维护一个日志文件，记录对文件的修改内容，每隔一段时间将修改与硬盘同步

## 文件之间数据组织

文件目录：
- 文件控制块（FCB，实现文件目录的数据结构）
	- <文件名,文件物理地址>
- 目录（FCB的有序集合，存储为文件）
	- 功能：
		- 搜索
		- 创建项
		- 删除项
		- 显示目录
		- 修改目录（重命名等）
- 目录结构
	- 单极目录结构
		- 整个系统只有一张目录，不能创建同名文件
	- 两级目录结构（多用户）
		- 主文件目录<用户,用户文件目录>
		- 用户文件目录<用户文件名,文件地址>
	- 多级目录结构（路径）
		- 根据绝对路径一层层读入目录表
		- 优化：记录当前目录（相对路径）
	- 无环目录结构（便于文件共享）
		- 可以用不同目录项指向同一个文件/目录
		- 需要对每个共享节点设置一个共享计数器，引用一次+1，删除一次-1
- 索引节点（对文件控制块的优化）
	- 目录中只存储<文件名,索引节点号>，其他内容（文件物理地址、元数据）放到文件索引节点中
	- 在磁盘中时称为“磁盘索引节点，”读入内存后称为“内存索引节点”
	- 内存索引节点还需要增加文件是否被修改、有几个进程正在访问该文件等信息。

## 系统调用
1. 创建create
2. 删除delete
3. 打开open
	- 打开文件：
		1. 找到对应目录文件
		2. 读取目录文件，获取文件的FCB
		3. 在内存的“打开文件表”中注册该FCB
			> 系统、各个进程均有“打开文件表”,
			> 进程的打开文件表包含系统打开文件表索引号、读写指针、访问权限；
			> 系统的打开文件表包含索引号、外存地址、打开计数器
4. 关闭close
5. 读文件read
6. 写文件write
7. 文件共享
	- 基于索引节点（硬链接）
		> 不同用户的目录指向同一个文件索引节点，存储一个计数器，删除可能影响源文件
	- 基于符号链（软连接）
		> 类似建立一个“快捷方式”文件，增删与源文件无关
8. 文件权限保护
	- 口令保护
		> 操作系统验证后允许访问，开销小，安全性小
	- 加密保护
		> 加密文件，用正确的密码才能解码，开销大，安全性大
	- 访问控制
		> FCB中记录访问控制表，记录各个用户对该文件不同操作的权限；
		> 利用用户组可以精简访问控制列表

## 存储空间管理
- 存储单元 (1B)
- 磁盘块/物理块 (1K)
	- 文件逻辑地址：物理块号+块内地址
	- 以块为单位进行分配、读取
- 分配方式
	- 连续分配：起始块号，长度（使用块的个数）
		- 支持随机访问
		- 顺序访问更快
		- 碎片多，文件大小扩展效率低
	- 链接分配
		- 隐式链接（**题目默认为隐式链接**）
			- 各个块使用一定空间存储下一个块的指针
			- IO次数多，要读每个块，查找效率低
		- 显式链接
			- 存储在FAT文件分配表（静态链表前向表）
			- 目录<文件名,起始块号>，起始块中存储文件分配表
			- IO次数少，只需要读取分配表
	- 索引分配
		- 为每个文件建立一张索引表（占用一个块-索引块）
		- 目录记录<文件名,索引块地址>
		- 索引表记录文件的<逻辑块,物理块>
		- 支持随机访问，方便文件拓展，占用空间大
		- 问题：文件过大，一个块中放不下索引表
			1. 多个索引块链接存储
			2. 多层索引（访问更快）
			3. 混合索引（解决多层索引小文件访问次数过多问题）
				- 顶级索引
					- 直接地址
					- 直接地址
					- 一级间接索引
						- 二级间接索引
						- 直接地址
					- ……
		- **考点**
			1. 根据索引结构计算文件最大长度
			2. 分析访问数据块的IO次数，注意顶级索引是否在内存中
- 存储空间管理
	- 存储空间划分
		- 文件卷（逻辑卷）
			- 目录区
			- 文件区
	- 管理方式
		- 空闲表法
			- 空闲表<空闲盘块首地址, 空闲盘块长度>
			- 分配：
				1. 首次适应
				2. 最佳适应
				3. 最坏适应
				4. ……
			- 回收
		- 空闲链表法
			- 空闲盘块链
				- 每个空闲盘块存储一个next
				- 分配：直接分配
			- 空闲盘区链
				- 连续的空闲盘块组成一个空闲盘区
				- 每个空闲盘区存储一个盘区长度、next
				- 分配：类似空闲表法
		- 位视图法
			- 0,1存储是否被占用
			- 字号i，位号j，字长w，盘号=w*i+j
		- 成组链接法（unix，适用于大型文件系统）

			文件卷分为文件区和目录区，目录区包含：
			- 目录
			- 超级块
				- 与内存同步
				- list<空闲块号>, listsize
				- list[0]存储了下一层的表
				- 本身也可以被分配
## 文件系统的层次结构
|层次|相关知识|功能|
|-|-|-|
|用户应用程序
|用户接口|文件基本操作|系统调用
|文件目录系统|文件目录|管理目录、FCB等
|存取控制模块|文件保护|权限验证，文件保护
|逻辑文件系统与文件信息缓冲区|文件逻辑结构|将文件记录好转换为文件的逻辑地址
|物理文件系统|文件物理结构|将文件逻辑地址转换为物理地址
|辅助分配模块|文件存储空间管理|分配、回收存储空间
|设备管理模块|磁盘管理|与硬件交互，分配设备、缓冲区，启动设备、释放设备等

答题模板：
1. *用户*通过*接口*发出*请求*
2. 通过路径，查找目录，找到对应目录项
3. 检查用户访问权限
4. 将用户提供的“文件记录号”转换为逻辑地址
5. 将逻辑地址转换为物理地址
6. 对磁盘发送请求
7. 如果需要，进行分配或回收

## 磁盘简介
1. 磁盘硬件
	- 磁道：一环
	- 扇区：等角度划分单个磁道
	- 内侧扇区数据密度最大
	- 多个盘，磁头选择的磁道是共进退的，磁道号改名为“柱面号”
	- **磁盘的物理地址：柱面号，盘面号，扇区号**
2. 磁盘调度算法
	- 性能度量
		- *寻道时间-移动磁头的时间（软件优化）
		- 延迟时间-扇区转过来的时间（转速）
		- 传输时间-读完内容的时间（转速）
	- 调度算法
		- 先来先服务FCFS
		- 最短寻找时间优先SSTF
			>离当前最近的磁道，**饥饿现象**
		- 扫描算法SCAN，电梯法
			> 移动到单向的物理尽头后才能掉头，**请求等待时间不平均**
			- Look算法，请求的单向极值就掉头
		- 循环扫描算法，C-SCAN
			> 0->max响应请求，max->0快速移动
			- C-Look算法，单向极值就掉头
	- 交替编号，节省磁头处理时间，实现交替读取-处理-读取-处理
	- 盘片间错位命名，实现流水线作业
## 磁盘管理
1. 磁盘初始化
	- 低级格式化（划分扇区、数据结构、校验方式）
	- 逻辑分区
	- 逻辑格式化，创建文件系统，根目录、数据结构
2. 创建引导块
	- 开机首先读取主板ROM程序
	- ROM程序读取引导块程序
3. 坏块处理
	- 逻辑格式化中，标注坏块（对操作系统不透明）
	- 磁盘控制器维护一个坏块链表，管理备用扇区（透明）